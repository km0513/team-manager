{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
  <h3 class="mb-6 text-2xl font-bold text-blue-700">HelperQA-AI</h3>
  <div class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-900 text-sm">
    <strong class="block mb-2 text-blue-800">HelperQA-AI Guide:</strong>
    <ul class="mb-2 list-disc list-inside">
      <li><strong>üì∑ Upload Screenshot</strong>: Performs UI analysis like layout issues or suggestions.</li>
      <li><strong>üåê Web Page URL</strong>: Captures and analyzes live web page layout.</li>
      <li><strong>üß™ Test Case Generator</strong>: Provide Jira ID, paste story, or upload document to get test cases.</li>
    </ul>
    <span class="block">The result will appear below with options to expand requirements or view Jira directly in-app.</span>
  </div>

  <form method="POST" enctype="multipart/form-data" id="feedbackForm" class="space-y-4">
    <div>
      <label for="inputType" class="block text-xs font-medium text-gray-600 mb-1">Choose Input Type</label>
      <select class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" id="inputType" name="input_type" required>
        <option value="">-- Select --</option>
        <option value="upload">üì∑ Upload Screenshot</option>
        <option value="url">üåê Enter Web Page URL</option>
        <option value="testcase_story">‚úçÔ∏è Test Case Generator (Story/Epic/Bug)</option>
      </select>
    </div>

    <!-- Screenshot Upload -->
    <div class="hidden" id="uploadGroup">
      <label class="block text-xs font-medium text-gray-600 mb-1">Upload Image</label>
      <input type="file" name="screenshot" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" accept="image/*">
    </div>

    <!-- URL Input -->
    <div class="hidden" id="urlGroup">
      <label class="block text-xs font-medium text-gray-600 mb-1">Enter Page URL</label>
      <input type="url" name="page_url" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" placeholder="https://example.com">
    </div>

    <!-- Test Case Generator Section -->
    <div id="testcaseGroup" class="hidden mt-2">
      <label class="block text-xs font-medium text-gray-600 mb-1">Enter Jira ID or Paste Story Description</label>
      <input type="text" name="jira_id" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm mb-2" placeholder="Optional: JIRA-1234">
      <textarea name="story_text" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm mb-2" rows="4" placeholder="Or paste the story/epic/bug here..."></textarea>
      <label class="block text-xs font-medium text-gray-600 mb-1">Or Upload a Document</label>
      <input type="file" name="story_doc" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" accept=".txt,.pdf,.doc,.docx">
    </div>

    <!-- Button Groups -->
    <div class="flex gap-2 mt-3 hidden" id="btnGroup">
      <input type="hidden" name="ai_mode" id="aiMode" value="review">
      <button type="submit" id="analyzeBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-800 text-white text-xs font-semibold rounded shadow">üîç Analyze UI</button>
      <button type="submit" id="testcaseBtn" class="px-4 py-2 bg-cyan-100 hover:bg-cyan-200 text-cyan-900 border border-cyan-400 text-xs font-semibold rounded shadow">üß™ Generate Test Cases</button>
    </div>
  </form>

  {% if image_url %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    <div>
      {% if page_url %}
      <h5 class="text-base font-semibold mb-1">Analyzed URL</h5>
      <code class="block mb-2 text-xs text-gray-600 bg-gray-100 rounded px-2 py-1">{{ page_url }}</code>
      {% endif %}
      <img src="{{ image_url }}" class="w-full rounded-lg shadow border border-gray-200" alt="Screenshot">
    </div>
    <div>
      <h5 class="text-base font-semibold mb-1">Analysis / Testcases</h5>
      <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg min-h-[200px] prose prose-sm max-w-none">
        {{ feedback | safe if feedback else "No analysis found." }}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  const feedbackForm = document.getElementById("feedbackForm");
  const inputType = document.getElementById("inputType");
  const uploadGroup = document.getElementById("uploadGroup");
  const urlGroup = document.getElementById("urlGroup");
  const testcaseGroup = document.getElementById("testcaseGroup");
  const btnGroup = document.getElementById("btnGroup");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const testcaseBtn = document.getElementById("testcaseBtn");
  const aiMode = document.getElementById("aiMode");

  inputType.addEventListener("change", function () {
    const type = this.value;

    // Visibility toggles (Tailwind: use hidden/block)
    uploadGroup.classList.toggle("hidden", type !== "upload");
    urlGroup.classList.toggle("hidden", type !== "url");
    testcaseGroup.classList.toggle("hidden", type !== "testcase_story");

    // Button logic
    if (type === "upload" || type === "url") {
      btnGroup.classList.remove("hidden");
      analyzeBtn.style.display = "inline-block";
      testcaseBtn.style.display = "inline-block";
      feedbackForm.action = "/HelperQA-AI";
      aiMode.value = "review";
    } else if (type === "testcase_story") {
      btnGroup.classList.remove("hidden");
      analyzeBtn.style.display = "none";
      testcaseBtn.style.display = "inline-block";
      feedbackForm.action = "/generate-testcases";
      aiMode.value = "testcases";
    } else {
      btnGroup.classList.add("hidden");
    }

    // Required fields
    document.querySelector('[name="screenshot"]').required = (type === "upload");
    document.querySelector('[name="page_url"]').required = (type === "url");
  });
</script>
{% endblock %}
