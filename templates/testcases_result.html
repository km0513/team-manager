{% extends "base.html" %}
{% block content %}
<!-- Alpine.js CDN for interactivity (if needed) -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
  [x-cloak] { display: none !important; }
</style>
<div class="max-w-5xl mx-auto px-4 py-8">
  <div class="bg-white rounded-xl shadow border border-upgradAccent p-6">
    <h3 class="mb-6 text-2xl font-bold text-upgradRed flex items-center gap-2">
      ðŸ§ª Generated Test Cases
      {% if jira_id %}
        <span class="ml-2 text-base text-upgradAccent font-normal">for <span class="font-semibold">{{ jira_id }}</span></span>
      {% else %}
        <span class="ml-2 text-base text-upgradAccent font-normal">from Uploaded Requirement</span>
      {% endif %}
    </h3>

    <!-- Alpine.js collapsible for original requirement -->
    <div x-data="{ open: false }" class="mb-6">
      <button @click="open = !open" class="flex items-center gap-2 px-4 py-2 bg-upgradYellow hover:bg-upgradAccent text-upgradRed rounded shadow text-sm font-semibold focus:outline-none">
        <svg :class="{'rotate-90': open}" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        <span>View Original Requirement</span>
      </button>
      <div x-show="open" x-transition x-cloak class="mt-3 bg-upgradLight border border-upgradAccent rounded p-4">
        {% if jira_id %}
          <iframe 
            src="{{ jira_base_url }}/browse/{{ jira_id }}" 
            width="100%" 
            height="500px" 
            frameborder="0"
            class="rounded"
            style="background: #fff;">
          </iframe>
        {% else %}
          <pre class="text-xs text-upgradAccent whitespace-pre-wrap">{{ original_requirement }}</pre>
        {% endif %}
      </div>
    </div>

    <p class="mb-4 text-upgradTeal font-medium">Here are some structured functional test cases based on the input provided:</p>

    <div class="overflow-x-auto rounded-lg border border-upgradAccent bg-upgradLight">
      <table class="min-w-[700px] w-full text-xs text-left" id="testcases-table">
        <thead class="bg-upgradYellow text-upgradRed">
          <tr>
            <th class="py-2 px-3 font-semibold w-1/5">Test Case</th>
            <th class="py-2 px-3 font-semibold w-1/5">Preconditions</th>
            <th class="py-2 px-3 font-semibold w-2/5">Test Steps</th>
            <th class="py-2 px-3 font-semibold w-1/5">Expected Result</th>
            <th class="py-2 px-3 font-semibold w-1/6">Edge Cases</th>
          </tr>
        </thead>
        <tbody>
          {{ content | safe }}
        </tbody>
      </table>
    </div>

    <div class="flex flex-col md:flex-row md:justify-between gap-2 mt-6">
      <a href="/HelperQA-AI" class="px-4 py-2 bg-upgradYellow hover:bg-upgradAccent text-upgradRed text-xs font-semibold rounded shadow text-center">â¬… Back to HelperQA-AI</a>
      <div class="flex flex-row gap-2">
        <button class="px-4 py-2 bg-upgradRed hover:bg-upgradAccent text-white text-xs font-semibold rounded shadow text-center" onclick="downloadTestCasesCSV()">â¬‡ Download as CSV</button>
      </div>
    </div>
  </div>
</div>

<script>
function downloadTestCasesCSV() {
  const table = document.querySelector('#testcases-table') || document.querySelector('table');
  let csvContent = 'Test Case,Preconditions,Test Steps,Expected Result,Edge Cases\n';
  table.querySelectorAll('tbody tr').forEach(row => {
    const cols = row.querySelectorAll('td');
    let rowData = [];
    for (let i = 0; i < 5; i++) {
      let cell = (cols[i]?.innerText || '').replace(/"/g, '""');
      if (cell.indexOf(',') !== -1 || cell.indexOf('"') !== -1 || cell.indexOf('\n') !== -1) {
        cell = '"' + cell.replace(/\n/g, ' ') + '"';
      }
      rowData.push(cell);
    }
    csvContent += rowData.join(',') + '\n';
  });
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.download = 'generated_testcases.csv';
  link.click();
}
</script>
{% endblock %}
