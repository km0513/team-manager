{% extends "base.html" %}
{% block content %}
<div class="container mt-4 d-flex justify-content-center">
  <div class="card shadow rounded-4 p-4 w-100" style="max-width: 1100px; background: #fffbe6; border: 2px solid #f5c542;">
    <h3 class="mb-4 text-danger fw-bold d-flex align-items-center" style="gap: 0.1rem; font-size: 1.25rem;">
      <span style="font-size: 1.25rem;">ðŸ§ª</span>
      Generated Test Cases for
      {% if jira_id %}
        <span class="text-dark fw-normal" style="font-size: 1.25rem;">
          <a href="{{ jira_base_url }}/browse/{{ jira_id }}" target="_blank" rel="noopener" style="text-decoration: underline; color: #b36b00;">{{ jira_id }}</a>
        </span>
      {% else %}
        <span class="text-dark fw-normal" style="font-size: 1.25rem;">Uploaded Requirement/Text:</span>
      {% endif %}
    </h3>

    {% if not jira_id %}
      <div class="mb-3">
        <button class="btn fw-bold mb-2 d-flex align-items-center" type="button" id="toggleReqBtn" style="background: #ffe066; color: #b36b00; border: 2px solid #b36b00; box-shadow: 0 2px 8px #ffe06655; font-size: 1.1rem;">
          <span id="toggleReqIcon" style="font-size: 1.1rem; margin-right: 0.5rem;">ðŸ“„</span> View Uploaded Requirement or Text
        </button>
        <div id="uploadedReqBox" style="display: none; background: #fffbe6; border-radius: 8px; padding: 14px; border: 2px solid #ffe066; white-space: pre-wrap; max-height: 350px; overflow-y: auto; font-size: 1.07rem; color: #222; box-shadow: 0 2px 12px #ffe06633;">
          {{ original_requirement|e }}
        </div>
      </div>
      <script>
        const btn = document.getElementById('toggleReqBtn');
        const box = document.getElementById('uploadedReqBox');
        const icon = document.getElementById('toggleReqIcon');
        btn.addEventListener('click', function() {
          if (box.style.display === 'none') {
            box.style.display = 'block';
            icon.textContent = 'â–¼';
          } else {
            box.style.display = 'none';
            icon.textContent = 'ðŸ“„';
          }
        });
      </script>
    {% endif %}


    <div class="table-responsive mb-0">
      <table class="table table-bordered align-middle mb-0" id="testcases-table" style="min-height: 200px;">
        <thead class="text-center" style="background: #ffe066; color: #b36b00; font-weight: bold;">
          <tr>
            <th style="width: 20%;">Test Case</th>
            <th style="width: 20%;">Preconditions</th>
            <th style="width: 30%;">Test Steps</th>
            <th style="width: 20%;">Expected Result</th>
            <th style="width: 10%;">Edge Cases</th>
          </tr>
        </thead>
        <tbody>
          {{ content | safe }}
        </tbody>
      </table>
    </div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
      <a href="/visual-feedback" class="btn btn-primary">â¬… Back to HelperQA-AI</a>
      <button class="btn btn-danger" onclick="downloadTestCasesCSV()">â¬‡ Download as CSV</button>
    </div>
  </div>
</div>

<script>
function downloadTestCasesCSV() {
  const table = document.getElementById('testcases-table');
  let csvContent = '';
  const rows = table.querySelectorAll('tr');
  rows.forEach(function(row) {
    const cols = row.querySelectorAll('th,td');
    let rowData = [];
    cols.forEach(function(col) {
      rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
    });
    csvContent += rowData.join(',') + '\n';
  });
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.download = 'generated_testcases.csv';
  link.click();
}
</script>
{% endblock %}
