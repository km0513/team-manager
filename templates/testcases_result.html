{% extends "base.html" %}
{% block content %}
<div class="container mt-4 d-flex justify-content-center">
  <div class="card shadow rounded-4 p-4 w-100" style="max-width: 1100px; background: #fffbe6; border: 2px solid #f5c542;">
    <h3 class="mb-4 text-danger fw-bold d-flex align-items-center">
      <span class="me-2" style="font-size: 1.7rem;">ðŸ§ª</span> Generated Test Cases for
      {% if jira_id %}
        <span class="ms-2 text-dark fw-normal" style="font-size: 1.1rem;"><a href="{{ jira_base_url }}/browse/{{ jira_id }}" target="_blank" rel="noopener" style="text-decoration: underline; color: #b36b00;">{{ jira_id }}</a></span>
      {% else %}
        <span class="ms-2 text-dark fw-normal" style="font-size: 1.1rem;">Uploaded Requirement/Text </span>
      {% endif %}
    </h3>

    {% if not jira_id %}
      <div class="mb-3">
        <div class="accordion" id="uploadedReqAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="uploadedReqHeading">
              <button class="accordion-button collapsed bg-warning-subtle fw-semibold rounded-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#uploadedReqCollapse"
                      aria-expanded="false" aria-controls="uploadedReqCollapse" style="font-size: 1rem;">
                <span class="me-2">â–¶</span> View Uploaded Requirement or Text
              </button>
            </h2>
            <div id="uploadedReqCollapse" class="accordion-collapse collapse"
                 aria-labelledby="uploadedReqHeading" data-bs-parent="#uploadedReqAccordion">
              <div class="accordion-body"
                   style="background: #fffde7; border-radius: 6px; padding: 10px; border: 1px solid #ffe066; white-space: pre-wrap; max-height: 350px; overflow-y: auto;">
                {{ original_requirement|e }}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <p class="fw-medium mb-3 text-success">Here are some structured functional test cases based on the input provided:</p>

    <div class="table-responsive mb-0">
      <table class="table table-bordered align-middle mb-0" id="testcases-table" style="min-height: 200px;">
        <thead class="text-center" style="background: #ffe066; color: #b36b00; font-weight: bold;">
          <tr>
            <th style="width: 20%;">Test Case</th>
            <th style="width: 20%;">Preconditions</th>
            <th style="width: 30%;">Test Steps</th>
            <th style="width: 20%;">Expected Result</th>
            <th style="width: 10%;">Edge Cases</th>
          </tr>
        </thead>
        <tbody>
          {{ content | safe }}
        </tbody>
      </table>
    </div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
      <a href="/visual-feedback" class="btn btn-primary">â¬… Back to HelperQA-AI</a>
      <button class="btn btn-danger" onclick="downloadTestCasesCSV()">â¬‡ Download as CSV</button>
    </div>
  </div>
</div>

<script>
function downloadTestCasesCSV() {
  const table = document.getElementById('testcases-table');
  let csvContent = '';
  const rows = table.querySelectorAll('tr');
  rows.forEach(function(row) {
    const cols = row.querySelectorAll('th,td');
    let rowData = [];
    cols.forEach(function(col) {
      rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
    });
    csvContent += rowData.join(',') + '\n';
  });
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.download = 'generated_testcases.csv';
  link.click();
}
</script>
{% endblock %}
