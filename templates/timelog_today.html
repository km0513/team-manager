{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>üìÖ Timelog for {{ display_date_str }}</h3>
  <div>
    <a href="{{ url_for('timelog_today', date=previous_date, work_function=selected_function) }}" class="btn btn-outline-secondary btn-sm">‚Üê Previous</a>
    {% if next_date %}
      <a href="{{ url_for('timelog_today', date=next_date, work_function=selected_function) }}" class="btn btn-outline-secondary btn-sm">Next ‚Üí</a>
    {% endif %}
  </div>
</div>

{% if not is_user_specific %}
<form method="POST" class="row g-3 mb-3 align-items-end">
  <div class="col-md-3">
    <label for="functionFilter" class="form-label">Function:</label>
    <select class="form-select" id="functionFilter" name="work_function" onchange="this.form.submit()">
      <option value="All" {% if selected_function == 'All' %}selected{% endif %}>All</option>
      {% for wf in work_functions %}
        <option value="{{ wf }}" {% if selected_function == wf %}selected{% endif %}>{{ wf }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Search User:</label>
    <input type="text" id="userSearch" class="form-control" placeholder="Type to filter users...">
  </div>
</form>
{% endif %}

{% if summary_data %}
<h5 class="mt-4">Summary</h5>
<table class="table table-bordered text-center align-middle">
  <thead class="table-light">
    <tr><th>User</th><th>Logged</th><th>Expected</th></tr>
  </thead>
  <tbody>
    {% set ns = namespace(total_logged=0, total_expected=0) %}
    {% for row in summary_data %}
    {% set ns.total_logged = ns.total_logged + row.total_hours %}
    {% set ns.total_expected = ns.total_expected + row.expected %}
    <tr class="summary-row" data-user="{{ row.user | lower }}">
      <td class="text-start">
        <a href="#collapse-{{ loop.index }}" class="summary-link text-decoration-none fw-medium" data-bs-toggle="collapse" data-target="#collapse-{{ loop.index }}">{{ row.user }}</a>
      </td>
      <td>
        <a href="#collapse-{{ loop.index }}" class="summary-link text-decoration-none" data-bs-toggle="collapse" data-target="#collapse-{{ loop.index }}" style="color: {{ 'green' if row.status == 'good' else 'red' }};">
          {{ row.total_hours | round_half }}
        </a>
      </td>
      <td>{{ row.expected | round_half }}</td>
    </tr>
    {% endfor %}
    <tr class="fw-bold table-secondary">
      <td class="text-end">TOTAL</td>
      <td>{{ ns.total_logged | round_half }}</td>
      <td>{{ ns.total_expected | round_half }}</td>
    </tr>
  </tbody>
</table>

<div class="mb-3">
  <button class="btn btn-outline-primary btn-sm me-2" type="button" onclick="expandAll(event)">Expand All</button>
  <button class="btn btn-outline-secondary btn-sm" type="button" onclick="collapseAll()">Collapse All</button>
</div>

<div class="accordion" id="timelogAccordion">
{% for row in summary_data %}
  <div class="accordion-item user-accordion" data-user="{{ row.user | lower }}">
    <h2 class="accordion-header" id="heading-{{ loop.index }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
        {{ row.user }} ({{ row.total_hours | round_half }} hrs)
      </button>
    </h2>
    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}">
      <div class="accordion-body">
        {% set logs_by_date = {} %}
        {% for item in detailed_data[row.user] %}
          {% set date = item.started if item.started else 'Unknown' %}
          {% set _ = logs_by_date.setdefault(date, []).append(item) %}
        {% endfor %}

        {% for log_date, items in logs_by_date.items() | sort %}
        <h6 class="text-muted mt-3">{{ log_date }}</h6>
        <table class="table table-sm table-striped">
          <thead class="table-secondary">
            <tr><th>Issue</th><th>Parent Summary</th><th>Task Summary</th><th>Hours</th></tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <td><a href="{{ item.link }}" class="jira-link" data-url="{{ item.link }}">{{ item.issue_key }}</a></td>
              <td>{{ item.parent_summary }}</td>
              <td>{{ item.summary }}</td>
              <td>{{ item.hours | round_half }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endfor %}
      </div>
    </div>
  </div>
{% endfor %}
</div>

<!-- Jira Modal -->
<div class="modal fade" id="jiraModal" tabindex="-1" aria-labelledby="jiraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" style="height:90%;">
    <div class="modal-content" style="height:100%;">
      <div class="modal-header">
        <h5 class="modal-title">Jira Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" style="height: calc(100% - 56px);">
        <iframe id="jiraFrame" src="" frameborder="0" style="width:100%; height:100%; border:none; transform: scale(0.85); transform-origin: top left;"></iframe>
      </div>
      <div class="modal-footer">
        <label class="me-2">Zoom:</label>
        <input type="range" min="50" max="125" value="85" id="zoomSlider">
      </div>
    </div>
  </div>
</div>

<script>
function expandAll(event) {
  event.preventDefault();
  document.querySelectorAll('.accordion-collapse').forEach(el => {
    bootstrap.Collapse.getOrCreateInstance(el).show();
  });
}
function collapseAll() {
  document.querySelectorAll('.accordion-collapse.show').forEach(el => {
    bootstrap.Collapse.getOrCreateInstance(el).hide();
  });
}
document.querySelectorAll('.jira-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const url = this.dataset.url;
    document.getElementById('jiraFrame').src = url;
    new bootstrap.Modal(document.getElementById('jiraModal')).show();
  });
});
document.getElementById('zoomSlider').addEventListener('input', function () {
  const scale = this.value / 100;
  document.getElementById('jiraFrame').style.transform = `scale(${scale})`;
});
document.getElementById('userSearch').addEventListener('input', function() {
  const filter = this.value.toLowerCase();
  document.querySelectorAll('.summary-row, .user-accordion').forEach(row => {
    const user = row.getAttribute('data-user');
    row.style.display = user.includes(filter) ? '' : 'none';
  });
});
document.querySelectorAll('.summary-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const targetId = this.getAttribute('data-target');
    const section = document.querySelector(targetId);
    const collapse = bootstrap.Collapse.getOrCreateInstance(section);
    collapse.show();
    setTimeout(() => {
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
  });
});
</script>

{% else %}
<p class="text-muted">No worklogs found for today.</p>
{% endif %}
{% endblock %}
