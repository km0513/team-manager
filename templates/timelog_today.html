{% extends 'base.html' %}
{% block content %}
<!-- Alpine.js CDN for collapsible accordions and modal -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
  [x-cloak] { display: none !important; }
</style>

<div class="max-w-5xl mx-auto px-2" x-data="timelogPage()">
  <div class="flex justify-between items-center mb-3">
    <h3 class="text-xl font-bold">üìÖ Timelog for {{ display_date_str }}</h3>
    <div class="flex gap-2">
      <a href="{{ url_for('timelog_today', user_email=user_email, date=previous_date) if is_user_specific else url_for('timelog_today', date=previous_date, work_function=selected_function) }}" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs font-semibold rounded shadow">‚Üê Previous</a>
      {% if next_date %}
      <a href="{{ url_for('timelog_today', user_email=user_email, date=next_date) if is_user_specific else url_for('timelog_today', date=next_date, work_function=selected_function) }}" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs font-semibold rounded shadow">Next ‚Üí</a>
      {% endif %}
    </div>
  </div>

  {% if not is_user_specific %}
  <div class="bg-white rounded-xl shadow p-6 mb-8">
    <form method="POST" class="flex flex-wrap gap-4 items-end">
      <div>
        <label for="functionFilter" class="block text-xs font-medium text-gray-600 mb-1">Function:</label>
        <select class="block w-40 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" id="functionFilter" name="work_function" onchange="this.form.submit()">
          <option value="All" {% if selected_function == 'All' %}selected{% endif %}>All</option>
          {% for wf in work_functions %}
            <option value="{{ wf }}" {% if selected_function == wf %}selected{% endif %}>{{ wf }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Search User:</label>
        <input type="text" id="userSearch" x-model="userFilter" class="block w-40 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm" placeholder="Type to filter users...">
      </div>
      <div class="flex items-center mt-2">
        <input type="checkbox" id="onlyReds" x-model="onlyReds" class="mr-2">
        <label for="onlyReds" class="text-xs font-bold text-upgradRed">Only Reds</label>
      </div>
    </form>
  </div>
  {% endif %}

  {% if summary_data %}
  <div id="summary-table" class="bg-white rounded-xl shadow p-6 mb-4">
    <h2 class="mb-4 text-lg font-bold text-blue-800">Summary</h2>
    <div class="overflow-x-auto">
      <table class="min-w-[500px] w-full bg-white rounded-lg border border-gray-200 text-xs text-center">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-2 px-3 font-semibold">User</th>
            <th class="py-2 px-3 font-semibold">Logged</th>
            <th class="py-2 px-3 font-semibold">Expected</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total_logged=0, total_expected=0) %}
          {% for row in summary_data %}
          {% set ns.total_logged = ns.total_logged + (row.numeric_hours | float) %}
          {% set ns.total_expected = ns.total_expected + 8 %}
          <tr class="border-t border-upgradAccent" x-show="userVisible('{{ row.user|lower }}') && (!onlyReds || ((row.total_hours is string and false) or ((row.total_hours | float(0)) < (row.expected | float(0)))) )">
            <td class="py-2 px-3 text-left font-bold">
              <a href="#user-{{ loop.index }}" class="text-upgradPurple hover:underline font-bold {% if (row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours)) %}text-gray-400{% elif (row.total_hours | float(0)) < (row.expected | float(0)) %}text-upgradRed{% endif %}" @click.prevent="expandAndScrollToUser('user-{{ loop.index }}', {{ loop.index }})">{{ row.user }}</a>
            </td>
            <td class="py-2 px-3 font-bold {% if (row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours)) %}text-gray-400{% elif (row.total_hours | float(0)) < (row.expected | float(0)) %}text-upgradRed{% else %}text-upgradTeal{% endif %}">
              {% if row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours) %}
                {{ row.total_hours }}
              {% else %}
                {{ row.total_hours | round_half }}
              {% endif %}
            </td>
            <td class="py-2 px-3">{{ row.expected | round_half }}</td>
          </tr>
          {% endfor %}
          <tr class="border-t border-gray-100 font-bold bg-gray-50">
            <td class="py-2 px-3 text-end">TOTAL</td>
            <td class="py-2 px-3">{{ ns.total_logged | round_half }}</td>
            <td class="py-2 px-3">{{ ns.total_expected }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="flex flex-wrap gap-2 justify-end mb-2">
    <button @click="expandAll()" class="px-3 py-1 bg-upgradYellow hover:bg-upgradAccent text-upgradRed text-xs font-bold rounded shadow border border-upgradAccent transition">Expand All</button>
    <button @click="collapseAll()" class="px-3 py-1 bg-upgradAccent hover:bg-upgradRed text-white text-xs font-bold rounded shadow border border-upgradAccent transition">Collapse All</button>
  </div>

  <div class="space-y-6 mt-6">
    {% for row in summary_data %}
    <div :id="'user-{{ loop.index }}'" class="bg-white rounded-xl shadow p-6" x-data="userLogCard(false, {{ loop.index }})" x-ref="'userCard' + {{ loop.index }}" x-show="userVisible('{{ row.user|lower }}') && (!onlyReds || ((row.total_hours is string and false) or ((row.total_hours | float(0)) < (row.expected | float(0)))) )" @expand-all.window="open = true" @collapse-all.window="open = false" @expand-user-{{ loop.index }}.window="open = true">
      <div class="flex justify-end mb-2">
        <button @click="backToTop()" class="text-xs text-blue-600 hover:text-blue-800 bg-blue-50 rounded px-2 py-1 border border-blue-200">Back to Top</button>
      </div>
      <button type="button" class="w-full flex justify-between items-center text-left text-upgradPurple hover:text-upgradRed font-bold text-xs focus:outline-none py-1 {% if (row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours)) %}bg-gray-100{% elif (row.total_hours | float(0)) < (row.expected | float(0)) %}bg-upgradPink/40{% endif %}" @click="open = !open">
        <span class="flex items-center gap-2 {% if (row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours)) %}text-gray-400{% elif (row.total_hours | float(0)) < (row.expected | float(0)) %}text-upgradRed{% endif %}">
          {{ row.user }}
          <span class="inline-block text-base font-extrabold text-upgradTeal ml-2">
            {% if row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours) %}
              {{ row.total_hours }}
            {% else %}
              {{ row.total_hours | round_half }} hrs
            {% endif %}
          </span>
        </span>
        <svg :class="{'rotate-180': open}" class="w-3 h-3 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      <div x-show="open" x-transition x-cloak class="mt-4 border-t pt-4">
        {% set logs_by_date = {} %}
        {% for item in detailed_data[row.user] %}
          {% set date = item.started if item.started else 'Unknown' %}
          {% set _ = logs_by_date.setdefault(date, []).append(item) %}
        {% endfor %}
        {% for log_date, items in logs_by_date.items() | sort %}
        <div class="mb-4">
          <h6 class="text-xs text-gray-500 font-semibold mb-2">{{ log_date }}</h6>
          <div class="overflow-x-auto">
            <table class="min-w-[500px] w-full bg-white rounded-lg border border-gray-200 text-xs text-center mb-2">
              <thead class="bg-gray-100 text-gray-700">
                <tr>
                  <th class="py-2 px-3 font-semibold">Issue</th>
                  <th class="py-2 px-3 font-semibold">Parent Summary</th>
                  <th class="py-2 px-3 font-semibold">Task Summary</th>
                  <th class="py-2 px-3 font-semibold">Hours</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr class="border-t border-gray-100">
                  <td><a href="#" class="text-blue-600 hover:underline" @click.prevent="openJiraModal('{{ item.link }}')">{{ item.issue_key }}</a></td>
                  <td>{{ item.parent_summary }}</td>
                  <td>{{ item.summary }}</td>
                  <td>{{ item.hours | round_half }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Jira Modal -->
  <div x-show="showModal" style="background: rgba(0,0,0,0.5)" class="fixed inset-0 flex items-center justify-center z-50" x-transition x-cloak>
    <div class="bg-white rounded-xl shadow-lg w-full max-w-5xl mx-2 overflow-hidden relative">
      <button @click="showModal=false" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
      <div class="w-full h-[90vh] overflow-auto flex items-center justify-center">
        <iframe :src="modalUrl" class="w-full h-full" frameborder="0" x-ref="jiraFrame" tabindex="-1" style="transform: scale(0.93); transform-origin: 0 0; width: 108%; height: 108%;"></iframe>
      </div>
    </div>
  </div>

  {% else %}
  <p class="text-muted">No worklogs found for today.</p>
  {% endif %}
</div>

<script>
function userLogCard(expanded, idx) {
  return {
    open: expanded || false,
    setOpen(val) { this.open = val; },
    backToTop() {
      const summary = document.getElementById('summary-table');
      if (summary) {
        window.scrollTo({
          top: summary.getBoundingClientRect().top + window.scrollY - 80,
          behavior: 'smooth'
        });
      }
    }
  }
}
function timelogPage() {
  return {
    userFilter: '',
    onlyReds: false,
    showModal: false,
    modalUrl: '',
    expandAll() {
      window.dispatchEvent(new CustomEvent('expand-all'));
    },
    collapseAll() {
      window.dispatchEvent(new CustomEvent('collapse-all'));
    },
    userVisible(name) {
      return !this.userFilter || name.includes(this.userFilter.toLowerCase());
    },
    expandAndScrollToUser(id, idx) {
      const el = document.getElementById(id);
      if (el) {
        window.scrollTo({
          top: el.getBoundingClientRect().top + window.scrollY - 80,
          behavior: 'smooth'
        });
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent(`expand-user-${idx}`));
        }, 200);
      }
    },
    openJiraModal(url) {
      this.modalUrl = url;
      this.showModal = true;
      this.$nextTick(() => {
        const frame = this.$refs.jiraFrame;
        if (frame) frame.focus();
      });
    }
  }
}
</script>
{% endblock %}
