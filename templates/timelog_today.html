{% extends 'base.html' %}
{% block content %}
<!-- Alpine.js CDN for collapsible accordions and modal -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
  [x-cloak] { display: none !important; }
</style>

<div class="max-w-5xl mx-auto px-2" x-data="timelogPage()">
  <!-- Date navigation (distinct from user pagination) -->
  <div class="flex justify-between items-center mb-4">
    <div>
      {% if previous_date %}
        {% if user_email %}
          <a href="{{ url_for('timelog_today', user_email=user_email) }}?date={{ previous_date }}" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs">Previous Day</a>
        {% else %}
          <a href="{{ url_for('timelog_today') }}?date={{ previous_date }}&work_function={{ selected_function }}" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs">Previous Day</a>
        {% endif %}
      {% endif %}
      {% if next_date %}
        {% if user_email %}
          <a href="{{ url_for('timelog_today', user_email=user_email) }}?date={{ next_date }}" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs ml-2">Next Day</a>
        {% else %}
          <a href="{{ url_for('timelog_today') }}?date={{ next_date }}&work_function={{ selected_function }}" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs ml-2">Next Day</a>
        {% endif %}
      {% endif %}
    </div>
    <span class="px-4 py-2 bg-gray-200 rounded">{{ display_date_str }}</span>
  </div>

  <h3 class="text-xl font-bold">üìÖ Timelog for {{ display_date_str }}</h3>

  {% if not is_user_specific %}
  <div class="bg-white rounded-xl shadow p-6 mb-8 border border-upgradAccent">
    <div class="flex flex-wrap gap-4 items-end mb-4">
      <form method="POST" class="flex flex-wrap gap-4 items-end">
        <div>
          <label for="functionFilter" class="block text-xs font-bold text-upgradRed mb-1">Function</label>
          <select class="block w-40 rounded-md border-upgradAccent shadow-sm focus:border-upgradRed focus:ring focus:ring-upgradYellow focus:ring-opacity-50 text-sm" id="functionFilter" name="work_function">
            <option value="All" {% if selected_function == 'All' %}selected{% endif %}>All Functions</option>
            {% for wf in work_functions %}
              <option value="{{ wf }}" {% if selected_function == wf %}selected{% endif %}>{{ wf }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-upgradRed mb-1">Search User:</label>
          <input type="text" id="userSearch" x-model="userFilter" class="block w-40 rounded-md border-upgradAccent shadow-sm focus:border-upgradRed focus:ring focus:ring-upgradYellow focus:ring-opacity-50 text-sm" placeholder="Type to filter users...">
        </div>
        <div class="flex items-center mt-2">
          <!-- Only Reds checkbox removed -->
        </div>
      </form>
      <a href="{{ url_for('timelog', user_email=user_email) }}" class="inline-flex items-center px-4 py-2 bg-upgradPurple hover:bg-upgradAccent text-white text-xs font-bold rounded shadow focus:outline-none transition ml-auto">Back to Timelog</a>
    </div>
  </div>
  {% endif %}

  {% if is_holiday %}
    <div class="bg-green-100 border border-green-400 text-green-800 rounded p-4 mt-8 mb-8 text-center font-semibold">
      <span class="text-xl">üéâ</span> Capacity is zero today due to <b>{{ holiday_name }}</b>! Take a break and celebrate!
    </div>
  {% elif is_weekend %}
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 rounded p-4 mt-8 mb-8 text-center font-semibold">
      <span class="text-xl">üåû</span> It's the weekend! No work, no capacity‚Äîenjoy your time off!
    </div>
  {% elif not summary_data or summary_data|length == 0 %}
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 rounded p-4 mt-8 mb-8 text-center font-semibold">
      <span class="text-xl">üìù</span> No timelogs have been entered for today.<br>
      <span>Please ensure you and your team enter your daily timelogs to maintain accurate records and enable effective tracking.</span>
    </div>
  {% endif %}

  {% if summary_data %}
  <div id="summary-table" class="bg-white rounded-xl shadow p-6 mb-4">
    <h2 class="mb-4 text-lg font-bold text-blue-800">Summary</h2>
    <div class="overflow-x-auto">
      <table class="min-w-[500px] w-full bg-white rounded-lg border border-upgradAccent text-xs text-center">
        <thead class="bg-upgradPurple text-white">
          <tr>
            <th class="py-2 px-3 font-bold">User</th>
            <th class="py-2 px-3 font-bold">Logged</th>
            <th class="py-2 px-3 font-bold">Expected</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(total_logged=0, total_expected=0) %}
          {% for row in summary_data %}
          {% set ns.total_logged = ns.total_logged + (row.total_hours | float) %}
          {% set ns.total_expected = ns.total_expected + 8 %}
          <tr class="border-t border-upgradAccent">
            <td class="py-2 px-3 text-left font-bold text-upgradPurple">
              <a href="#user-{{ loop.index }}" class="hover:underline font-bold" @click.prevent="expandAndScrollToUser('user-{{ loop.index }}', {{ loop.index }})">{{ row.user }}</a>
            </td>
            <td class="py-2 px-3 font-bold text-upgradTeal">{{ row.total_hours | round_half }}</td>
            <td class="py-2 px-3 text-black">{{ row.expected | round_half }}</td>
          </tr>
          {% endfor %}
          <tr class="border-t border-upgradAccent font-bold bg-upgradLight">
            <td class="py-2 px-3 text-end">TOTAL</td>
            <td class="py-2 px-3">{{ ns.total_logged | round_half }}</td>
            <td class="py-2 px-3">{{ ns.total_expected }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- User pagination controls (distinct, below date navigation) -->
  {% if user_page and (next_user_page or prev_user_page) %}
  <div class="flex justify-center my-4 gap-2">
    {% if prev_user_page %}
      <form method="get">
        <input type="hidden" name="date" value="{{ start }}">
        <input type="hidden" name="work_function" value="{{ selected_function }}">
        <input type="hidden" name="user_page" value="{{ prev_user_page }}">
        <input type="hidden" name="user_email" value="{{ user_email }}">
        <button type="submit" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs">Previous Users</button>
      </form>
    {% endif %}
    <span class="px-4 py-2 bg-gray-200 rounded">User Page {{ user_page }}</span>
    {% if next_user_page %}
      <form method="get">
        <input type="hidden" name="date" value="{{ start }}">
        <input type="hidden" name="work_function" value="{{ selected_function }}">
        <input type="hidden" name="user_page" value="{{ next_user_page }}">
        <input type="hidden" name="user_email" value="{{ user_email }}">
        <button type="submit" class="px-3 py-1 rounded bg-upgradRed text-white font-bold text-xs">Next Users</button>
      </form>
    {% endif %}
  </div>
  {% endif %}

  <div class="flex flex-wrap gap-2 justify-end mb-2">
    <button @click="expandAll()" class="px-3 py-1 bg-upgradYellow hover:bg-upgradAccent text-upgradRed text-xs font-bold rounded shadow border border-upgradAccent transition">Expand All</button>
    <button @click="collapseAll()" class="px-3 py-1 bg-upgradAccent hover:bg-upgradRed text-white text-xs font-bold rounded shadow border border-upgradAccent transition">Collapse All</button>
  </div>

  <div class="space-y-6 mt-6">
    {% for row in summary_data %}
    <div :id="'user-{{ loop.index }}'" class="bg-white rounded-xl shadow p-6 border border-upgradAccent" x-data="userLogCard(false, {{ loop.index }})" x-ref="'userCard' + {{ loop.index }}" x-show="userVisible('{{ row.user|lower }}')" @expand-all.window="open = true" @collapse-all.window="open = false" @expand-user-{{ loop.index }}.window="open = true">
      <div class="flex justify-end mb-2">
        <button @click="backToTop()" class="text-xs text-upgradRed hover:text-upgradPurple bg-upgradPink rounded px-2 py-1 border border-upgradAccent">Back to Top</button>
      </div>
      <button type="button" class="w-full flex justify-between items-center text-left text-upgradPurple hover:text-upgradRed font-bold text-xs focus:outline-none py-1" @click="open = !open">
        <span class="flex items-center gap-2">
          {{ row.user }}
          {% set is_red = (row.total_hours is number and row.expected is number and row.total_hours < row.expected) %}
          <span class="inline-block text-base font-extrabold {{ 'text-upgradRed' if is_red else 'text-upgradTeal' }} ml-2">
            {% if row.total_hours is string and ('On Leave' in row.total_hours or 'Leave' in row.total_hours or 'Holiday' in row.total_hours) %}
              {{ row.total_hours }}
            {% else %}
              {{ row.total_hours | round_half }} hrs
            {% endif %}
          </span>
        </span>
        <svg :class="{'rotate-180': open}" class="w-3 h-3 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      <div x-show="open" x-transition x-cloak class="mt-4 border-t pt-4">
        {% set logs_by_date = {} %}
        {% for item in detailed_data[row.user] %}
          {% set date = item.started if item.started else 'Unknown' %}
          {% set _ = logs_by_date.setdefault(date, []).append(item) %}
        {% endfor %}
        {% for log_date, items in logs_by_date.items() | sort %}
        <div class="mb-4">
          <h6 class="text-xs text-gray-500 font-semibold mb-2">{{ display_date_str }}</h6>
          <div class="overflow-x-auto">
            <table class="min-w-[500px] w-full bg-white rounded-lg border border-upgradAccent text-xs text-center mb-2">
              <thead>
                <tr class="bg-upgradPurple text-white">
                  <th class="py-2 px-3">Issue</th>
                  <th class="py-2 px-3">Parent Summary</th>
                  <th class="py-2 px-3">Task Summary</th>
                  <th class="py-2 px-3">Hours</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr>
                  <td class="text-upgradPurple font-bold">
                    <a href="https://upgrad-jira.atlassian.net/browse/{{ item.issue_key }}"
                       onclick="event.preventDefault(); openJiraModal('https://upgrad-jira.atlassian.net/browse/{{ item.issue_key }}')"
                       class="text-upgradPurple underline hover:text-upgradRed font-bold cursor-pointer">
                       {{ item.issue_key }}
                    </a>
                  </td>
                  <td>{{ item.parent_summary }}</td>
                  <td>{{ item.summary }}</td>
                  <td>{{ item.hours }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Modal for Jira iframe -->
  <div x-show="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-2xl relative">
      <button @click="showModal=false" class="absolute top-2 right-2 text-upgradRed font-bold">&times;</button>
      <iframe :src="modalUrl" x-ref="jiraFrame" class="w-full h-[600px] rounded-b-lg border-0"></iframe>
    </div>
  </div>

  <!-- Jira Modal (iframe) with zoom and styled close button -->
  <div id="jiraModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="relative bg-white rounded shadow-xl scale-95 transition-transform duration-200 flex flex-col" style="max-width:90vw;max-height:90vh;">
      <button onclick="closeJiraModal()" class="absolute top-2 right-2 bg-red-600 hover:bg-red-800 text-white font-bold py-1 px-4 rounded shadow text-lg z-10">Close</button>
      <iframe id="jiraIframe" src="" class="rounded" style="width:80vw;height:70vh;border:none;"></iframe>
    </div>
  </div>

  <script>
  function userLogCard(expanded, idx) {
    return {
      open: expanded || false,
      setOpen(val) { this.open = val; },
      backToTop() {
        const summary = document.getElementById('summary-table');
        if (summary) {
          window.scrollTo({
            top: summary.getBoundingClientRect().top + window.scrollY - 80,
            behavior: 'smooth'
          });
        }
      }
    }
  }
  function timelogPage() {
    return {
      userFilter: '',
      showModal: false,
      modalUrl: '',
      expandAll() {
        window.dispatchEvent(new CustomEvent('expand-all'));
      },
      collapseAll() {
        window.dispatchEvent(new CustomEvent('collapse-all'));
      },
      userVisible(name) {
        return !this.userFilter || name.includes(this.userFilter.toLowerCase());
      },
      expandAndScrollToUser(id, idx) {
        const el = document.getElementById(id);
        if (el) {
          window.scrollTo({
            top: el.getBoundingClientRect().top + window.scrollY - 80,
            behavior: 'smooth'
          });
          setTimeout(() => {
            window.dispatchEvent(new CustomEvent(`expand-user-${idx}`));
          }, 200);
        }
      },
      openJiraModal(url) {
        this.modalUrl = url;
        this.showModal = true;
        this.$nextTick(() => {
          const frame = this.$refs.jiraFrame;
          if (frame) frame.focus();
        });
      }
    }
  }
  function openJiraModal(url) {
    document.getElementById('jiraModal').classList.remove('hidden');
    document.getElementById('jiraIframe').src = url;
    document.body.style.overflow = 'hidden';
  }
  function closeJiraModal() {
    document.getElementById('jiraModal').classList.add('hidden');
    document.getElementById('jiraIframe').src = '';
    document.body.style.overflow = '';
  }
  </script>

  <!-- Spinner CSS for non-Bootstrap environments -->
  <style>
  .spinner-border {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    vertical-align: text-bottom;
    border: 0.15em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
  }
  @keyframes spinner-border {
    100% { transform: rotate(360deg); }
  }
  </style>

  {% else %}
  <p class="text-muted">No worklogs found for today.</p>
  {% endif %}
</div>

{% endblock %}
